name: Build MyLauncher (macOS Full Qt)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-mac:
    runs-on: macos-latest

    steps:
      # 1. Скачиваем код
      - uses: actions/checkout@v4

      # 2. Устанавливаем Qt через Homebrew
      - name: Install Qt dependencies
        run: |
          brew update
          brew install qt@6 qtsvg qpdf qtvirtualkeyboard

      # 3. Настраиваем переменные окружения для Qt
      - name: Setup Qt environment
        run: |
          export PATH="/opt/homebrew/opt/qt@6/bin:$PATH"
          export DYLD_FRAMEWORK_PATH="/opt/homebrew/opt/qt@6/lib"
          export PKG_CONFIG_PATH="/opt/homebrew/opt/qt@6/lib/pkgconfig"
          echo "Qt environment set"

      # 4. Конфигурируем проект через CMake с Xcode генератором
      - name: Configure CMake (Xcode)
        run: |
          mkdir -p build
          cd build
          cmake -G Xcode ..

      # 5. Собираем проект в Release
      - name: Build MyLauncher
        run: |
          cmake --build build --config Release

      # 6. Проверяем, что .app создан
      - name: List build/Release
        run: |
          ls -la build/Release/

      # 7. Деплойим Qt фреймворки в .app через macdeployqt
      - name: Deploy Qt into MyLauncher.app
        run: |
          cd build/Release
          macdeployqt MyLauncher.app -verbose=3

      # 8. Проверяем, что все фреймворки подключены
      - name: Check linked frameworks
        run: |
          cd build/Release
          otool -L MyLauncher.app/Contents/MacOS/MyLauncher

      # 9. Загружаем готовый .app как артефакт
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MyLauncher-mac
          path: build/Release/MyLauncher.app
